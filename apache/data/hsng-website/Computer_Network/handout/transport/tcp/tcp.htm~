<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
   <TITLE></TITLE>
   <META NAME="Author" CONTENT="">
   <META NAME="GENERATOR" CONTENT="Mozilla/3.0Gold (Win95; I) [Netscape]">
</HEAD>
<BODY BACKGROUND="../../gif/bg-slate.gif">

<UL>
<UL>
<UL>
<P><IMG SRC="titile.gif" HEIGHT=59 WIDTH=340></P>
</UL>
</UL>
</UL>

<TABLE BGCOLOR="#FF0000" >
<TR>
<TD COLSPAN="3"><B><FONT COLOR="#FFFFFF"><FONT SIZE=+2>TCP 協定　　　　　　　　　　　　　　　　　　</FONT></FONT></B></TD>
</TR>
</TABLE>

<UL>
<P><FONT SIZE=+1>　　許多網路應用均需傳輸層提供完全可靠的傳輸 ， 例 如
FTP、<BR>
WWW 、 telnet 等 。 在 Internet 上 ， TCP （ Transmission Control<BR>
Protocol）協定在 IP 上提供了完全可靠的傳輸服務 。 TCP 是屬於<BR>
end-to-end service，在 router 上並不需要有 TCP 的協定。</FONT></P>

<P><IMG SRC="F20_1.gif" HEIGHT=224 WIDTH=501></P>

<P><FONT SIZE=+1>　　TCP 是提供以 byte 為單位之一對一的可靠傳輸 ， 資料
沒有<BR>
structure 的觀念。傳輸前須以 3-way handshake 建立連線，之後兩<BR>
端均可送收資料（full duplex）。連線結束則使用 3-way handshake<BR>
加 timer 的 graceful disconnect 方式。以下是 TCP 的 FSM（Fininte<BR>
State Machine）圖。</FONT></P>
</UL>

<P><IMG SRC="tcpfsm.gif" HEIGHT=777 WIDTH=620></P>

<UL>
<P><FONT SIZE=+1>　　TCP 的封包格式如下圖所示：</FONT></P>

<UL>
<TABLE BORDER=1 >
<TR>
<TD COLSPAN="3">
<CENTER><FONT SIZE=+1>source port</FONT> </CENTER>
</TD>

<TD COLSPAN="3">
<CENTER><FONT SIZE=+1>　 　Destination port　　 </FONT></CENTER>
</TD>
</TR>

<TR>
<TD COLSPAN="6">
<CENTER><FONT SIZE=+1>sequence number</FONT> </CENTER>
</TD>
</TR>

<TR>
<TD COLSPAN="6">
<CENTER><FONT SIZE=+1>Acknowlegement number</FONT> </CENTER>
</TD>
</TR>

<TR>
<TD>
<CENTER><FONT SIZE=+1>Data offset</FONT> </CENTER>
</TD>

<TD>
<CENTER><FONT SIZE=+1>Reserved</FONT> </CENTER>
</TD>

<TD>
<CENTER><FONT SIZE=+1>Flags</FONT> </CENTER>
</TD>

<TD COLSPAN="3">
<CENTER><FONT SIZE=+1>Window</FONT> </CENTER>
</TD>
</TR>

<TR>
<TD COLSPAN="3">
<CENTER><FONT SIZE=+1>Checksum</FONT> </CENTER>
</TD>

<TD COLSPAN="3">
<CENTER><FONT SIZE=+1>Urgent pointer</FONT> </CENTER>
</TD>
</TR>

<TR>
<TD COLSPAN="6">
<CENTER><FONT SIZE=+1>Options(+padding)</FONT> </CENTER>
</TD>
</TR>

<TR>
<TD COLSPAN="6">
<CENTER><FONT SIZE=+1>Date (variable)</FONT> </CENTER>
</TD>
</TR>
</TABLE>
</UL>

<P><FONT SIZE=+1>　　TCP 的定址方式是利用 port 號碼，共 16 bits（可達 65536
個<BR>
）。這是因為用 IP 位址可以指定某一台機器，但此機器上可能用<BR>
許多的 process在使用TCP，為 multiplex / demultiplex不同的process<BR>
的資料，所以每一個 TCP connection 均有一單獨使用的 port 號碼<BR>
。以下是系統保留，常見的保留 port 碼：</FONT></P>

<UL>
<TABLE BORDER=1>
<TR><TD ><CENTER><FONT SIZE=2>Decimal</FONT></CENTER>
</TD><TD ><CENTER><FONT SIZE=2>Keyword</FONT></CENTER>
</TD><TD ><CENTER><FONT SIZE=2>UNIX Keyword</FONT></CENTER>
</TD><TD ><CENTER><FONT SIZE=2>Description</FONT></CENTER>
</TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>0</FONT></CENTER></TD><TD >
</TD><TD ></TD><TD ><FONT SIZE=2>Reserved</FONT>
</TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>1</FONT></CENTER></TD><TD ><CENTER><FONT SIZE=2>TCPMUX</FONT></CENTER>
</TD><TD ><CENTER><FONT SIZE=2>-</FONT></CENTER></TD>
<TD ><FONT SIZE=2>TCP Multiplexor</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>5</FONT></CENTER></TD><TD ><CENTER><FONT SIZE=2>RJE</FONT></CENTER>
</TD><TD ><CENTER><FONT SIZE=2>-</FONT></CENTER></TD>
<TD ><FONT SIZE=2>Remote Job Entry</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>7</FONT></CENTER></TD><TD ><CENTER><FONT SIZE=2>ECHO</FONT></CENTER>
</TD><TD ><CENTER><FONT SIZE=2>echo</FONT></CENTER></TD>
<TD ><FONT SIZE=2>Echo</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>9</FONT></CENTER></TD><TD ><CENTER><FONT SIZE=2>DISCARD</FONT></CENTER>
</TD><TD ><CENTER><FONT SIZE=2>discard</FONT></CENTER>
</TD><TD ><FONT SIZE=2>Discard</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>11</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>USERS</FONT></CENTER></TD><TD ><CENTER><FONT SIZE=2>systat</FONT></CENTER>
</TD><TD ><FONT SIZE=2>Active Users</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>13</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>DAYTIME</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>daytime</FONT></CENTER></TD>
<TD ><FONT SIZE=2>Daytime</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>15</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>-</FONT></CENTER></TD><TD ><CENTER><FONT SIZE=2>netstat</FONT></CENTER>
</TD><TD ><FONT SIZE=2>Network status program</FONT>
</TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>17</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>QUOTE</FONT></CENTER></TD><TD ><CENTER><FONT SIZE=2>qotd</FONT></CENTER>
</TD><TD ><FONT SIZE=2>Quote of the Day</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>19</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>CHARGEN</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>chargen</FONT></CENTER></TD>
<TD ><FONT SIZE=2>Character Generator</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>20</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>FTP-DATA</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>ftp-data</FONT></CENTER></TD>
<TD ><FONT SIZE=2>File Transfer Protocol (data)</FONT>
</TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>21</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>FTP</FONT></CENTER></TD><TD ><CENTER><FONT SIZE=2>ftp</FONT></CENTER>
</TD><TD ><FONT SIZE=2>File Transfer Protocol</FONT>
</TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>23</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>TELNET</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>telnet</FONT></CENTER></TD>
<TD ><FONT SIZE=2>Terminal Connection</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>25</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>SMTP</FONT></CENTER></TD><TD ><CENTER><FONT SIZE=2>smtp</FONT></CENTER>
</TD><TD ><FONT SIZE=2>Simple Mail Transport Protocol</FONT>
</TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>37</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>TIME</FONT></CENTER></TD><TD ><CENTER><FONT SIZE=2>time</FONT></CENTER>
</TD><TD ><FONT SIZE=2>Time</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>42</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>NAMESERVER</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>name</FONT></CENTER></TD><TD ><FONT SIZE=2>Host Name Server</FONT>
</TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>43</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>NlCNAME</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>whois</FONT></CENTER></TD><TD ><FONT SIZE=2>Who Is</FONT>
</TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>53</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>DOMAIN</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>nameserver</FONT></CENTER></TD>
<TD ><FONT SIZE=2>Domain Name Server</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>77</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>-</FONT></CENTER></TD><TD ><CENTER><FONT SIZE=2>rje</FONT></CENTER>
</TD><TD ><FONT SIZE=2>any private RJE service</FONT>
</TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>79</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>FINGER</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>finger</FONT></CENTER></TD>
<TD ><FONT SIZE=2>Finger</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>93</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>DCP</FONT></CENTER></TD><TD ><CENTER><FONT SIZE=2>-</FONT></CENTER>
</TD><TD ><FONT SIZE=2>Device Control Protocol</FONT>
</TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>95</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>SUPDUP</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>supdup</FONT></CENTER></TD>
<TD ><FONT SIZE=2>SUPDUP Protocol</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>101</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>HOSTNAME</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>hostnames</FONT></CENTER></TD>
<TD ><FONT SIZE=2>NIC Host Name Server</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>102</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>lSO-TSAP</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>iso-tsap</FONT></CENTER></TD>
<TD ><FONT SIZE=2>lSO-TSAP</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>103</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>X400</FONT></CENTER></TD><TD ><CENTER><FONT SIZE=2>x400</FONT></CENTER>
</TD><TD ><FONT SIZE=2>X.400 Mail Service</FONT></TD>
</TR>
<TR><TD ><CENTER><FONT SIZE=2>104</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>X400-SND</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>x400-snd</FONT></CENTER></TD>
<TD ><FONT SIZE=2>X.400 Mail Sending</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>111</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>SUNRPC</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>sunrpc</FONT></CENTER></TD>
<TD ><FONT SIZE=2>SUN Remote Procedure Call</FONT></TD>
</TR>
<TR><TD ><CENTER><FONT SIZE=2>113</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>AUTH</FONT></CENTER></TD><TD ><CENTER><FONT SIZE=2>auth</FONT></CENTER>
</TD><TD ><FONT SIZE=2>Authentication Service</FONT>
</TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>117</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>UUCP-PATH</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>uucp-path</FONT></CENTER></TD>
<TD ><FONT SIZE=2>UUCP Path Service</FONT></TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>119</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>NNTP</FONT></CENTER></TD><TD ><CENTER><FONT SIZE=2>nntp</FONT></CENTER>
</TD><TD ><FONT SIZE=2>USENET News Transfer Protocol</FONT>
</TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>129</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>PWDGEN</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>-</FONT></CENTER></TD><TD ><FONT SIZE=2>Password Generator Protocol</FONT>
</TD></TR>
<TR><TD ><CENTER><FONT SIZE=2>139</FONT></CENTER></TD>
<TD ><CENTER><FONT SIZE=2>NETBlOS-SSN</FONT></CENTER>
</TD><TD ><CENTER><FONT SIZE=2>-</FONT></CENTER></TD>
<TD ><FONT SIZE=2>NETBIOS Session Service</FONT></TD>
</TR>
<TR><TD ><CENTER><FONT SIZE=2>160-223</FONT></CENTER>
</TD><TD ><CENTER><FONT SIZE=2>Reserved</FONT></CENTER>
</TD><TD ></TD><TD ></TD></TR>
</TABLE>
</UL>

<P><FONT SIZE=+1>　　Sequence number 與 ACK number 是可靠傳輸必備的。 Data<BR>
offset 是指 header 長度（因有 option，所以不固定） 。 6-bit flag<BR>
表示馬上將資料傳出，不必等到 MSS（maximum segment size）<BR>
那麼大再送，RST，SYN，FIN 等 3 個 flags 則是 connection 建立<BR>
與拆除時使用之控制碼。window 是 flow control 時由reciever告知<BR>
sender 其 buffer 之大小。checksum 是以 16-bit 為 單 位 將 pseudo<BR>
header+header+data 加總後取 1 的補數。其中 pseudo header 是：</FONT></P>

<UL>
<UL>
<TABLE BORDER=1 >
<CAPTION>
<FONT SIZE=+1>0　　 　 　　 　 　 　 　 　 　 　31</FONT>
</CAPTION>

<TR>
<TD COLSPAN="4">
<CENTER><FONT SIZE=+1>source IP address</FONT></CENTER>
</TD>
</TR>

<TR>
<TD COLSPAN="4">
<CENTER><FONT SIZE=+1>destination IP address</FONT></CENTER>
</TD>
</TR>

<TR>
<TD>
<CENTER><FONT SIZE=+1>zero</FONT></CENTER>
</TD>

<TD>
<CENTER><FONT SIZE=+1>protocol</FONT></CENTER>
</TD>

<TD COLSPAN="2">
<CENTER><FONT SIZE=+1>　　data length　　</FONT></CENTER>
</TD>
</TR>
</TABLE>
</UL>
</UL>

<P><FONT SIZE=+1>　　options 是一些控制功能，如設定 MSS 或 timestamp 等。</FONT></P>
</UL>

<TABLE BGCOLOR="#FF0000" >
<TR>
<TD COLSPAN="3"><B><FONT COLOR="#FFFFFF"><FONT SIZE=+2>TCP Flow Control　　　　　　　　　　　　　　</FONT></FONT></B></TD>
</TR>
</TABLE>

<UL>
<P><FONT SIZE=+1>　　TCP 使用 sliding window protocol（with positive ACK）來進行<BR>
flow control。ACK 是指目前收到的 byte 數（不是 packet 為單位）<BR>
。sending window 之大小由 receiver 視其 buffer 之大小以 header中<BR>
之 window 欄位通知 sender。雖然 TCP 使用 GBN 的方法，但 re-<BR>
ceiver 會對 out of order 之資料 buffer 起來，只是 ACK 時是送pos-<BR>
tive ACK 告知 sender 目前按順序收到的 byte 數目。</FONT></P>
</UL>

<TABLE BGCOLOR="#FF0000" >
<TR>
<TD COLSPAN="3"><B><FONT COLOR="#FFFFFF"><FONT SIZE=+2>TCP Congestion Control
　 　 　　　　　　　　　</FONT></FONT></B></TD>
</TR>
</TABLE>

<UL>
<P><FONT SIZE=+1>　　TCP 也是利用 window-based 的 congestion control。sender
會<BR>
維持一個 congestion control window（不同於 flow control window）<BR>
，所有送出而未 ACK 之資料的 byte 總和需小於 minimum（con-<BR>
gestion control window，flow control window）。Sender在遇到網路<BR>
壅塞時，採用 multiplicative decrease，在網路通暢時 則 使 用 slow<BR>
start 及 congestion avoidance 之方法 。 以 下 是 TCP 的 congestion <BR>
control algorithm：</FONT></P>

<P><FONT SIZE=+1><FONT COLOR="#0000FF">Initial</FONT>:　congestion_window_size
= 1</FONT></P>

<P><FONT SIZE=+1>　　 　 threshold = 64 KB</FONT></P>

<P><FONT SIZE=+1><FONT COLOR="#0000FF">Loop</FONT>:　 if ( <FONT COLOR="#800000">ACK
received in time and congestion_window_size &lt;=<BR>
　　　　　threshold</FONT>)<BR>
　　　　　congestion_window_size++;<BR>
　　 　 else if ( <FONT COLOR="#800000">ACK received in time and congestion_window_size
&gt;<BR>
　　　　　threshold</FONT>)<BR>
　　　　　congestion_window_size+=1/congestion_window_size+1/8<BR>
　　 　 else if ( <FONT COLOR="#800000">packet time out</FONT>) {<BR>
　　　　　congestion_window_size = 1<BR>
　　　　　threshold /= 2<BR>
　　　　　time out 值加倍<BR>
　　 　 }</FONT></P>

<P><FONT SIZE=+1>　　以上 algorithm 的 congestion window size 是以 MSS
為單 位 ，<BR>
真正 implement 時須以 byte 為單位。例如，如果 MSS = 256 bytes<BR>
，threshold = 512 bytes，congestion_window_size =768 bytes，則此<BR>
時若正常收到 一 個 ACK ， 新 的 congestion_window_size = 768 +<BR>
(256/768) * 256 + 256/8 = 885 bytes。</FONT></P>

<P><FONT SIZE=+1>　　在 TCP 的 congestion control algorithm 中，設定 packet
time 時<BR>
間正確與否影響 congestion control 甚大 。 所以該如何設定 packet<BR>
time out 時間是很重要的 。packet 的 time out 應設成比 Round Trip<BR>
Time （RTT）要大一點 。RFC 的建議是設成 β×RTT （ default<BR>
β= 2）。而 RTT 如何設定呢？ TCP 是以線上測量的方式進行。<BR>
當一個新的 ACK 回來後 ， 計算此 packet 從 送 出到 ACK 回來之<BR>
RTT 時 間 （ measured_RTT ） 。 新 的 RTT 就 更 正 為 ：<BR>
α* measured_RTT + ( 1 -α)* old_RTT 。 但是如果此 ACK 是 re-<BR>
transmission 的 packet 的 ACK，則不計算（Karn's algorithm）。如<BR>
果有 packet time out，則將下個 packet time out 的值加倍。</FONT></P>
<FONT SIZE=+1></FONT></UL>

</BODY>
</HTML>
